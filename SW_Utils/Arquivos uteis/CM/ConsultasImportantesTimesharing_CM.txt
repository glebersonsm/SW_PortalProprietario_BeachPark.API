***---Disponibilidade---***
SELECT D.DATA, R.IDHOTEL, T.CODREDUZIDO, T.IDTIPOUH,
       SUM(CASE WHEN R.STATUSRESERVA = 7 THEN 0 ELSE 1 END) AS TOTOCUPADA,
       SUM(CASE WHEN R.STATUSRESERVA = 7 THEN 1 ELSE 0 END) AS TOTWAITLIST,
       SUM(CASE WHEN R.STATUSRESERVA = 0 THEN 1 ELSE 0 END) AS TOTACONFIRMAR,
       SUM(CASE WHEN R.STATUSRESERVA = 1 THEN 1 ELSE 0 END) AS TOTCONFIRMADA,
       SUM(CASE WHEN R.STATUSRESERVA = 7 THEN 0 ELSE DECODE(SIGN(TO_NUMBER(DATA-  COALESCE(A.DATACUTOFF-1,DATA))),1,1,0) END) AS QTDALLOTMENTS,
       SUM(CASE WHEN R.TIPOUHESTADIA = A.IDTIPOUH THEN 1 ELSE 0 END) AS QTDALLOTREAL
  FROM (SELECT IDHOTEL, DATA FROM DATASIS WHERE (3 < 1 OR IDHOTEL = 3) AND (DATA BETWEEN TO_DATE('01/09/2025 00:00:00','dd/mm/yyyy hh24:mi:ss') AND TO_DATE('01/10/2025 00:00:00','dd/mm/yyyy hh24:mi:ss')) AND (IDHOTEL IN
         (SELECT H.IDHOTEL FROM HOTEL H INNER JOIN EMPRESAPROP P ON (H.IDPESSOA=P.IDPESSOA) AND COALESCE(P.FLGATIVO,'N')='S'))) D INNER JOIN
       TIPOUH T ON ((D.IDHOTEL = T.IDHOTEL) AND (T.FLGAPARECENADISP <> 'N') AND (COALESCE(T.FLGATIVA,'N') = 'S')) LEFT OUTER JOIN
       RESERVASFRONT R ON (T.IDHOTEL = R.IDHOTEL AND T.IDTIPOUH = R.TIPOUHESTADIA AND R.STATUSRESERVA < 4) LEFT OUTER JOIN
       ALLOTMENTXTIPOUH A ON (R.IDALLOTXTIPOUH = A.IDALLOTXTIPOUH AND R.IDHOTEL = A.IDHOTEL) INNER JOIN
       RESERVAREDUZ RD ON ((D.IDHOTEL = RD.IDHOTEL) AND (R.IDRESERVASFRONT = RD.IDRESERVASFRONT))
 WHERE
       (R.POOLLISTA = 'N')
   AND (R.IDROOMLIST IS NULL)
   AND (RD.DATACHEGADA <= D.DATA)
   AND (RD.DATAPARTIDA > D.DATA)
 GROUP BY D.DATA, R.IDHOTEL, T.CODREDUZIDO, T.IDTIPOUH
 ORDER BY R.IDHOTEL, D.DATA, T.IDTIPOUH, T.CODREDUZIDO

***---Disponibilidade inicial---***
SELECT CP.IDCONTRTSXPONTOS, CP.IDHOTEL, TD.FLGFERIADO, TU.IDTIPOUH, CP.FLGDESCONTO, D.DATA
  FROM CONTRTSXPONTOS CP
  JOIN TEMPORADATSXDATA TD ON TD.IDTEMPORADATS    = CP.IDTEMPORADATS
  JOIN TIPOUHXPONTOTS TU ON CP.IDCONTRTSXPONTOS = TU.IDCONTRTSXPONTOS
  JOIN DATASIS D ON D.IDHOTEL = CP.IDHOTEL
 WHERE CP.IDCONTRATOTS = 37
   AND CP.IDHOTEL      IN (1)
   AND ((TO_DATE('21/08/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') BETWEEN TD.DATAINICIAL-40 AND TD.DATAFINAL+40 AND TO_DATE('21/09/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') BETWEEN TD.DATAINICIAL-40 AND TD.DATAFINAL+40 AND TD.FLGFERIADO = 'N')
    OR (TD.DATAFINAL >= TO_DATE('21/08/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') AND  TD.DATAINICIAL <= TO_DATE('21/09/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') AND TD.FLGFERIADO  = 'S'))
   AND TD.FLGBLOQUEIAUSO  <> 'S'
   AND D.DATA BETWEEN TD.DATAINICIAL AND TD.DATAFINAL
 ORDER BY CP.IDHOTEL, TU.IDTIPOUH, D.DATA, CP.FLGDESCONTO DESC, TD.FLGFERIADO DESC

***---Bloqueios---**
SELECT B.FLGLIBERADO, B.OBSERVACAO, M.DESCRICAO, B.DATABLOQUEIO, U.NOMEUSUARIO AS USUARIOBLOQUEIO,        PJ.NUMEROPROJETO ||'-'||TO_CHAR(TO_NUMBER(VC.NUMEROCONTRATO)) AS NUMEROCONTRATO             FROM BLOQCLIENTETS B                                                                               JOIN USUARIOSISTEMA U ON B.IDUSUARIO = U.IDUSUARIO                                                 JOIN MOTIVOTS M ON B.IDMOTIVOTS = M.IDMOTIVOTS                                                     LEFT JOIN VENDAXCONTRATOTS VC ON B.IDVENDAXCONTRATO = VC.IDVENDAXCONTRATO                          LEFT JOIN PROJETOTS PJ ON VC.IDPROJETOTS = PJ.IDPROJETOTS                                          LEFT JOIN AGENCIATS AG ON PJ.IDAGENCIATS = AG.IDAGENCIATS                                         WHERE B.FLGLIBERADO = 'N'                                                                          AND B.IDCLIENTE = 2141327   AND (VC.IDVENDAXCONTRATO IS NULL OR AG.IDPESSOA = 3)            ORDER BY B.DATABLOQUEIO DESC

***---Fracionamentos---**
(SELECT VC.IDVENDAXCONTRATO
FROM   FRACIONAMENTOTS F, RESERVASFRONT R, VENDAXCONTRATOTS VC, CONTRATOTS C, ATENDCLIENTETS A
WHERE  F.IDRESERVASFRONT1 = R.IDRESERVASFRONT
AND    VC.IDATENDCLIENTETS = A.IDATENDCLIENTETS
AND    F.IDRESERVASFRONT2 IS NULL
AND    R.STATUSRESERVA    <> 6
AND    COALESCE(C.PERCPONTOSSEGUTI,0) = 0
AND    F.IDVENDAXCONTRATO = VC.IDVENDAXCONTRATO
AND    VC.IDCONTRATOTS    = C.IDCONTRATOTS
AND    (R.DATACHEGPREVISTA + COALESCE(C.NUMMAXDIASFECFRAC,0)) >= TO_DATE('21/08/2025 00:00:00','DD/MM/YYYY HH24:MI:SS')
AND    A.IDCLIENTE        = 2141327 )
UNION
(SELECT VC.IDVENDAXCONTRATO
FROM   FRACIONAMENTOTS F, RESERVASFRONT R, VENDAXCONTRATOTS VC, CONTRATOTS C, ATENDCLIENTETS A 
WHERE  F.IDRESERVASFRONT2 = R.IDRESERVASFRONT
AND    F.IDVENDAXCONTRATO = VC.IDVENDAXCONTRATO
AND    VC.IDATENDCLIENTETS = A.IDATENDCLIENTETS
AND    VC.IDCONTRATOTS    = C.IDCONTRATOTS
AND    R.STATUSRESERVA    = 6
AND    COALESCE(C.PERCPONTOSSEGUTI,0) = 0
AND    (R.DATACHEGPREVISTA + COALESCE(C.NUMMAXDIASFECFRAC,0)) >= TO_DATE('21/08/2025 00:00:00','DD/MM/YYYY HH24:MI:SS')
AND    (R.DATACHEGPREVISTA - R.DATACANCELAMENTO) >= C.NUMMINDIASCANCRES
AND    A.IDCLIENTE        = 2141327)

***---Saldo---***
SELECT   VC.IDVENDAXCONTRATO,
         P.NUMEROPROJETO ||'-'|| TO_CHAR(TO_NUMBER(VC.NUMEROCONTRATO)) AS NUMEROCONTRATO,
         C.IDCONTRATOTS,
         C.NOME,
         C.NUMEROPONTOS - COALESCE(Sum( TO_NUMBER(DECODE(L.DEBITOCREDITO, 'C',-L.NUMEROPONTOS,L.NUMEROPONTOS)) *
                                   TO_NUMBER(DECODE(L.IDTIPOLANCPONTOTS, 1, DECODE(R.STATUSRESERVA, 6, 0, 1), 1))), 0) AS SALDO,
         COALESCE(CRED.CREDITO, 0) AS CREDITO
FROM     ATENDCLIENTETS  A, VENDATS V, VENDAXCONTRATOTS VC,
         CONTRATOTS C, LANCPONTOSTS L, PROJETOTS P, RESERVASFRONT R, AGENCIATS,
         (SELECT VC.IDVENDAXCONTRATO, Sum(LP.NUMEROPONTOS) AS CREDITO
          FROM   ATENDCLIENTETS A, VENDATS V, VENDAXCONTRATOTS VC, LANCPONTOSTS LP, PARAMTS P
          WHERE  A.IDCLIENTE = 2141327
          AND    V.IDATENDCLIENTETS = A.IDATENDCLIENTETS
          AND    VC.IDVENDATS = V.IDVENDATS
          AND    LP.IDVENDAXCONTRATO   = VC.IDVENDAXCONTRATO
          AND    P.IDHOTEL = A.IDHOTEL
          AND    LP.VALIDADECREDITO   >= P.DATASISTEMA
          AND    LP.DATALANCAMENTO    <= P.DATASISTEMA
          AND    LP.VALIDADECREDITO    IS NOT NULL
          AND    LP.DEBITOCREDITO      = 'D'
          AND    LP.IDTIPOLANCPONTOTS  = 4
          AND    LP.IDRESERVASFRONT    IS NULL
          AND    LP.IDRESERVAMIGRADA   IS NULL
          GROUP BY VC.IDVENDAXCONTRATO) CRED
WHERE    A.IDCLIENTE              = 2141327
AND      V.IDATENDCLIENTETS       = A.IDATENDCLIENTETS
AND      VC.IDVENDATS             = V.IDVENDATS
AND      C.IDCONTRATOTS           = VC.IDCONTRATOTS
AND      L.IDRESERVASFRONT        = R.IDRESERVASFRONT (+)
AND      L.IDVENDAXCONTRATO (+)   = VC.IDVENDAXCONTRATO
AND      VC.IDVENDAXCONTRATO      = CRED.IDVENDAXCONTRATO(+)
AND      VC.IDAGENCIATS           = AGENCIATS.IDAGENCIATS
AND      VC.FLGCANCELADO          = 'N'
AND      VC.FLGREVERTIDO          = 'N'
AND      VC.IDPROJETOTS           = P.IDPROJETOTS
AND      ((VC.PREVENDA = 'N') OR (VC.PREVENDA IS NULL))
AND      AGENCIATS.IDPESSOA       = 3

GROUP BY VC.IDVENDAXCONTRATO, VC.NUMEROCONTRATO, P.NUMEROPROJETO, C.IDCONTRATOTS, C.NOME, L.IDVENDAXCONTRATO, C.NUMEROPONTOS, CRED.CREDITO
HAVING   (C.NUMEROPONTOS -  COALESCE(Sum( TO_NUMBER(DECODE(L.DEBITOCREDITO, 'C',-L.NUMEROPONTOS,L.NUMEROPONTOS)) *
                                    TO_NUMBER(DECODE(L.IDTIPOLANCPONTOTS, 1, DECODE(R.STATUSRESERVA, 6, 0, 1), 1))), 0) + COALESCE(CRED.CREDITO, 0) > 0)

***---Hoteis---**
SELECT P.NOME, H.IDHOTEL, COALESCE(PH.DATASISTEMA, PTS.DATASISTEMA) AS DATASISTEMA, COALESCE(HTS.FLGTIPO,'N') AS FLGTIPO, HTS.DIAINICIALSEMANA, H.OBSERVACAO
  FROM PESSOA P, HOTEL H, CONTRATOTSXHOTEL CH, PARAMHOTEL PH, PARAMTS PTS, HOTEL HP, HOTELTS HTS, CONTRATOTS C
 WHERE P.IDPESSOA      = H.IDHOTEL
   AND H.IDHOTEL       = CH.IDHOTEL
   AND CH.IDCONTRATOTS = C.IDCONTRATOTS
   AND H.IDHOTEL       = PH.IDHOTEL (+)
   AND H.IDHOTEL       = HTS.IDHOTEL (+)
   AND PTS.IDHOTEL     = HP.IDHOTEL
   AND H.ATIVO         = 'S'
   AND CH.IDCONTRATOTS = 37
   AND C.IDHOTEL       = 3
 GROUP BY P.NOME, H.IDHOTEL, COALESCE(PH.DATASISTEMA, PTS.DATASISTEMA), HTS.FLGTIPO, HTS.DIAINICIALSEMANA, H.OBSERVACAO
 ORDER BY P.NOME

**---Pensao---**
SELECT PF.CODPENSAOCM AS CODPENSAO, PF.DESCRICAO AS DESCPENSAO, P.IDPESSOA AS IDHOTEL, P.NOME AS HOTEL, PTS.*   FROM PENSAOTS PTS, PENSAOFRONT PF, PESSOA P                                                                  WHERE PTS.CODPENSAO = PF.CODPENSAOCM                                                                            AND PTS.IDHOTEL   = P.IDPESSOA                                                                                AND PTS.IDHOTEL   = 1
**---Lançamentos do contrato---**
SELECT L.*,
       L.IDLANCAMENTOTS AS ORDEM,
       L.VLRLANCAMENTO AS VLRORIGINAL,
       0.0 AS IDLANCAMENTOTEMP,
       0.0 AS IDLANCESTORNOTEMP,
       0.0 AS CODALTERADORCANC,
       0.0 AS PLANOCONTACANC,
       T.CODREDUZIDO,
       T.IDOPERADORAPAGRECORRENTE,

       CASE WHEN L.IDLANCESTORNO IS NULL THEN
         CASE WHEN L.IDMOTIVOESTORNO IS NULL THEN
           CASE WHEN T.DESCRICAO IS NOT NULL THEN T.DESCRICAO ELSE FP.DESCRICAO END
         ELSE
           'Estorno de '||T.DESCRICAO
         END
       ELSE
        'E '||T.DESCRICAO
       END AS DESCRICAO,

       CASE WHEN L.IDLANCESTORNO IS NULL THEN
         CASE WHEN L.IDMOTIVOESTORNO IS NULL THEN
                TP.DESCRICAO
         ELSE
           'Estorno de '||TP.DESCRICAO
         END
       ELSE
        'E '||TP.DESCRICAO
       END AS DESCRICAO_PRINCIPAL,

       V.IDATENDCLIENTETS,
       V.IDVENDATS,
       V.IDAGENCIATS,
       '                                        ' AS COMENTARIO,
       0.0 AS CONTROLE,
       CASE WHEN CAR.SALDOCAR           IS NULL THEN 0 ELSE CAR.SALDOCAR           END AS SALDOCAR,
       CASE WHEN CAR.VALORPAGOCAR       IS NULL THEN 0 ELSE CAR.VALORPAGOCAR       END AS VALORPAGOCAR,
       CASE WHEN CAR.TOTALPARCELAS      IS NULL THEN 0 ELSE CAR.TOTALPARCELAS      END AS TOTALPARCELAS,
       CASE WHEN CAR.TOTALCANCELAMENTOS IS NULL THEN 0 ELSE CAR.TOTALCANCELAMENTOS END AS TOTALCANCELAMENTOS,
       CASE WHEN CAR.TOTALOUTROS        IS NULL THEN 0 ELSE CAR.TOTALOUTROS        END AS TOTALOUTROS,

       CASE WHEN L.CODDOCUMENTO IS NULL THEN
         CASE WHEN P.DATASISTEMA = L.DATALANCAMENTO THEN
           CASE WHEN T.CODTIPDOC IS NULL THEN
             'Nao integrado'
           ELSE
             CASE WHEN L.IDMOTIVOESTORNO IS NULL THEN
               CASE WHEN (CASE WHEN L.FLGMIGRADO IS NULL THEN 'N' ELSE L.FLGMIGRADO END) = 'N' THEN
                 'Aguardando auditoria'
               ELSE
                 'Nao integrado'
               END
             ELSE
               'Nao integrado'
             END
           END
         ELSE
           'Nao integrado'
         END
       ELSE
         CASE WHEN CASE WHEN CAR.ESTORNADO IS NULL THEN 'N' ELSE CAR.ESTORNADO END = 'N' THEN
           CASE WHEN CASE WHEN CAR.SALDOCAR IS NULL THEN 0 ELSE CAR.SALDOCAR END = 0 THEN
             CASE WHEN CASE WHEN CAR.TOTALCANCELAMENTOS IS NULL THEN 0 ELSE CAR.TOTALCANCELAMENTOS END = 0 THEN
               'Quitado'
             ELSE
               'Cancelado'
             END
           ELSE
             CASE WHEN CASE WHEN CAR.NUMFATURA IS NULL THEN 0 ELSE CAR.NUMFATURA END = 0 THEN
               'Em aberto'
             ELSE
               'Quitado'
             END
           END
         ELSE
           'Cancelado'
         END
       END AS STATUSCAR,

       COALESCE(CAR.DATAVENCTO, L.DATAPAGAMENTO) AS DATAVENCTO,

       COALESCE(PAGT_REC_NOVO.DESCSTATUSTS, PAGT_REC.DESCSTATUSTS) AS STATUS_PAGTREC,
       COALESCE(PAGT_REC_NOVO.CODIGOSTATUS, PAGT_REC.CODIGOSTATUS) AS CODIGOSTATUS,
       COALESCE(PAGT_REC_NOVO.COR, PAGT_REC.COR)                   AS COR,

       L.DATAPAGAMENTO,
       CAR.DATAVENCTO AS DATAVENCTOCAR,

       CASE WHEN L.IDTIPOLANCAMENTO IN (1,7) THEN NULL ELSE
         CASE WHEN T.FLGCONSIDERARPAGTOCOMERCIAL = 'S' THEN 'Quitado' END
       END AS STATUSCOMERCIAL,

       CAR.DATAPROGRAMADA, T.DEBITOCREDITO, T.IDCARTAOCREDITO, L.FLGTAXAADM, ' ' AS ESTORNA,
       CASE WHEN CAR.DATABAIXA IS NULL THEN L.DATAPAGAMENTO ELSE CAR.DATABAIXA END AS DATABAIXA,
       CAR.DATABAIXA AS DATABAIXACAR, CAR.CONTABAIXA, AJ.IDVENDAXCONTRATO AS IDVENDAXCONTRATOAJ,
       FP.DESCRICAO AS FORMAPAGTO, T.FLGDESCONTO, PAGT_REC.CODIGOSTATUS, PAGT_REC.COR,
       ' ' AS FLGESTORNAR,
       CASE
          WHEN SUBSTR(L.COMPLDOCUMENTO,1,1) = 'S' THEN 'Sinal: '         || SUBSTR(L.COMPLDOCUMENTO,2,LENGTH(L.COMPLDOCUMENTO)-1)
          WHEN SUBSTR(L.COMPLDOCUMENTO,1,1) = 'E' THEN 'Entrada: '       || SUBSTR(L.COMPLDOCUMENTO,2,LENGTH(L.COMPLDOCUMENTO)-1)
          WHEN SUBSTR(L.COMPLDOCUMENTO,1,1) = 'I' THEN 'Intermediária: ' || SUBSTR(L.COMPLDOCUMENTO,2,LENGTH(L.COMPLDOCUMENTO)-1)
          WHEN SUBSTR(L.COMPLDOCUMENTO,1,1) = 'P' THEN 'Parcela: '       || SUBSTR(L.COMPLDOCUMENTO,2,LENGTH(L.COMPLDOCUMENTO)-1)
       END AS COMPLEMENTODOC,

       COALESCE(
       (SELECT CASE WHEN L.IDAJUSTEFINANCTS > 0 THEN IDAJUSTEFINANCTS || '/' || L.IDAJUSTEFINANCTS ELSE TO_CHAR(IDAJUSTEFINANCTS) END FROM LANCAMENTOTS WHERE IDLANCAMENTOTS = L.IDLANCESTORNO),
       (SELECT TO_CHAR(IDAJUSTEFINANCTS) FROM LANCAMENTOTS WHERE IDLANCAMENTOTS = L.IDLANCAMENTOTS),
       '') GRUPOAJUSTE,
       COALESCE(CAR.DATAPROGRAMADA, L.DATAPAGAMENTO) AS DTPROGRAMADA

  FROM LANCAMENTOTS L
  JOIN VENDATS V ON L.IDVENDATS = V.IDVENDATS
  JOIN PARAMTS P ON L.IDHOTEL = P.IDHOTEL
  LEFT JOIN TIPODEBCREDHOTEL T ON L.IDTIPODEBCRED = T.IDTIPODEBCRED AND L.IDHOTEL = T.IDHOTEL
  LEFT JOIN TIPODEBCREDHOTEL TP ON T.IDPRINCIPAL = TP.IDTIPODEBCRED AND T.IDHOTEL = TP.IDHOTEL
  LEFT JOIN FORMAPAGTOTS FP ON L.IDFORMAPAGTO = FP.IDFORMAPAGTO
  LEFT JOIN AJUSTEFINANCTS AJ ON L.IDAJUSTEFINANCTS = AJ.IDAJUSTEFINANCTS
  LEFT JOIN (SELECT CASE WHEN (SUM(CASE WHEN TOT.OPERACAO = 2 THEN
                                   CASE WHEN TOT.ESTORNO IS NULL THEN 0 ELSE 1 END
                                   ELSE 0 END
                                   ) ) = 0 THEN 'N' ELSE 'S' END AS ESTORNADO,

                    TOT.CODDOCUMENTO, TOT.IDFORCLI, TOT.DATAVENCTO, TOT.DATAPROGRAMADA,

                    SUM( CASE WHEN TOT.OPERACAO = 3 THEN TO_NUMBER(TOT.VALOR) ELSE 0 END) AS TOTALPARCELAS,
                    SUM( CASE WHEN TOT.OPERACAO = 4 THEN TO_NUMBER(TOT.VALOR) * TOT.CANCELAMENTO ELSE 0 END ) AS TOTALCANCELAMENTOS,
                    SUM( CASE WHEN TOT.OPERACAO = 3 THEN 0 ELSE CASE WHEN TOT.OPERACAO = 4 THEN TOT.VALOR * TOT.OUTROS ELSE TOT.VALOR END END ) AS TOTALOUTROS,
                    SUM(TOT.VALOR) AS SALDOCAR,

                    SUM(TO_NUMBER( CASE WHEN TOT.OPERACAO = '10' THEN
                                     TOT.VALOR
                                   ELSE
                                     TO_NUMBER( CASE WHEN TOT.DEBCRE = 'C' THEN TOT.VALOR*-1 ELSE TOT.VALOR END )
                                   END ) * TO_NUMBER( CASE WHEN OPERACAO = '5 ' THEN 1
                                                           WHEN OPERACAO = '10' THEN 1
                                                           WHEN OPERACAO = '15' THEN 1 ELSE 0 END)) AS VALORPAGOCAR,

                    TOT.DATABAIXA, TOT.CONTABAIXA, TOT.NUMFATURA
               FROM
                    (SELECT L.OPERACAO, ESTORNO, D.CODDOCUMENTO, D.IDFORCLI, D.DATAVENCTO, D.DATAPROGRAMADA, L.DEBCRE,
                            CASE WHEN L.VALOR IS NULL THEN 0 ELSE CASE WHEN L.DEBCRE = 'D' THEN L.VALOR ELSE -L.VALOR END END VALOR,
                            L.CODALTERADOR, A.IDAGENCIATS, L.NUMLANCTO, D.NUMFATURA, BAIXA.DATABAIXA, BAIXA.CONTABAIXA,
                            (SELECT CASE WHEN SUM(1) IS NULL THEN 0 WHEN SUM(1) = 0 THEN 0 ELSE 1 END FROM TIPOALTERCANCEL TC WHERE TC.CODALTERADOR = L.CODALTERADOR AND TC.IDAGENCIATS = A.IDAGENCIATS) AS CANCELAMENTO,
                            (SELECT CASE WHEN SUM(1) IS NULL THEN 1 WHEN SUM(1) = 0 THEN 1 ELSE 0 END FROM TIPOALTERCANCEL TC WHERE TC.CODALTERADOR = L.CODALTERADOR AND TC.IDAGENCIATS = A.IDAGENCIATS) AS OUTROS

                       FROM DOCUMENTO D
                       JOIN LANCTODOCUM L ON D.CODDOCUMENTO = L.CODDOCUMENTO
                       JOIN LANCAMENTOTS LTS ON D.CODDOCUMENTO = LTS.CODDOCUMENTO
                       JOIN VENDATS V ON LTS.IDVENDATS = V.IDVENDATS
                       JOIN ATENDCLIENTETS A ON V.IDATENDCLIENTETS = A.IDATENDCLIENTETS
                       LEFT JOIN (SELECT R.CODDOCUMENTO, MAX(R.DATABAIXA) AS DATABAIXA, MAX(P.DESCRICAO) AS CONTABAIXA
                                    FROM RECBTOPAGTO R
                                    JOIN PORTADORFORMA P ON R.CODPORTFORMA = P.CODPORTFORMA
                                    JOIN LANCTODOCUM L ON R.NUMLANCTO = L.NUMLANCTO
                                   WHERE L.ESTORNO IS NULL
                                   GROUP BY R.CODDOCUMENTO) BAIXA ON D.CODDOCUMENTO = BAIXA.CODDOCUMENTO
                      WHERE V.IDVENDATS = 7139
                        AND D.RECPAG    = 'R'
                        AND D.IDPESSOA  = 3 ) TOT
                      GROUP BY TOT.IDFORCLI, TOT.CODDOCUMENTO, TOT.DATAVENCTO, TOT.DATAPROGRAMADA, TOT.DATABAIXA, TOT.CONTABAIXA, TOT.NUMFATURA) CAR ON L.CODDOCUMENTO = CAR.CODDOCUMENTO

  LEFT JOIN (SELECT LCR.CODDOCUMENTO, LCR.CODIGOSTATUS, STATUSRECORRENCIA.COR, STATUSRECORRENCIA.DESCSTATUSTS
               FROM LANCCONTROLERECORRENCIA LCR
               JOIN STATUSRECORRENCIA ON STATUSRECORRENCIA.CODIGOSTATUS = LCR.CODIGOSTATUS
              WHERE LCR.IDLANCCONTROLERECORRENCIA = (SELECT MAX(IDLANCCONTROLERECORRENCIA)
                                                       FROM LANCCONTROLERECORRENCIA
                                                      WHERE CODDOCUMENTO = LCR.CODDOCUMENTO)
              GROUP BY LCR.CODDOCUMENTO, LCR.CODIGOSTATUS, STATUSRECORRENCIA.COR, STATUSRECORRENCIA.DESCSTATUSTS) PAGT_REC ON CAR.CODDOCUMENTO = PAGT_REC.CODDOCUMENTO

  LEFT JOIN (SELECT L.CODDOCUMENTO, P.CODIGOSTATUS, S.COR, P.STATUSFATURA, P.STATUSGATEWAY,
                    CASE
                      WHEN P.STATUSFATURA = 'paid' THEN S.DESCRICAO
                    ELSE
                      CASE
                        WHEN P.STATUSGATEWAY IS NOT NULL THEN S.DESCRICAO || '  -  ' || P.STATUSGATEWAY
                      ELSE S.DESCRICAO
                    END
                   END AS DESCSTATUSTS
                 FROM LANCPAGRECORRENTETS P
                   JOIN LANCAMENTOTS L ON L.IDLANCAMENTOTS = P.IDLANCAMENTOTS
                   JOIN STATUSRECORRENCIATS S ON S.CODIGOSTATUS = P.CODIGOSTATUS
               WHERE P.IDLANCPAGRECORRENTETS = ( SELECT MAX(IDLANCPAGRECORRENTETS)
                                                   FROM LANCPAGRECORRENTETS L2
                                                  WHERE L2.IDLANCAMENTOTS = P.IDLANCAMENTOTS )
              GROUP BY L.CODDOCUMENTO, P.CODIGOSTATUS, S.COR, P.STATUSFATURA, S.DESCRICAO, P.STATUSGATEWAY ) PAGT_REC_NOVO ON CAR.CODDOCUMENTO = PAGT_REC_NOVO.CODDOCUMENTO

 WHERE V.IDVENDATS = 7139
   AND ((L.FLGREMOVIDO IS NULL) OR (L.FLGREMOVIDO IS NOT NULL AND (L.IDLANCESTORNO IS NULL AND L.IDMOTIVOESTORNO IS NULL) ))
 ORDER BY L.IDLANCAMENTOTS


SELECT D.DATA, R.IDHOTEL, T.CODREDUZIDO, T.IDTIPOUH,
       SUM(CASE WHEN R.STATUSRESERVA = 7 THEN 0 ELSE 1 END) AS TOTOCUPADA,
       SUM(CASE WHEN R.STATUSRESERVA = 7 THEN 1 ELSE 0 END) AS TOTWAITLIST,
       SUM(CASE WHEN R.STATUSRESERVA = 0 THEN 1 ELSE 0 END) AS TOTACONFIRMAR,
       SUM(CASE WHEN R.STATUSRESERVA = 1 THEN 1 ELSE 0 END) AS TOTCONFIRMADA,
       SUM(CASE WHEN R.STATUSRESERVA = 7 THEN 0 ELSE DECODE(SIGN(TO_NUMBER(DATA-  COALESCE(A.DATACUTOFF-1,DATA))),1,1,0) END) AS QTDALLOTMENTS,
       SUM(CASE WHEN R.TIPOUHESTADIA = A.IDTIPOUH THEN 1 ELSE 0 END) AS QTDALLOTREAL
  FROM (SELECT IDHOTEL, DATA FROM DATASIS WHERE (1 < 1 OR IDHOTEL = 1) AND (DATA BETWEEN TO_DATE('21/08/2025 00:00:00','dd/mm/yyyy hh24:mi:ss') AND TO_DATE('20/09/2025 00:00:00','dd/mm/yyyy hh24:mi:ss')) AND (IDHOTEL IN
         (SELECT H.IDHOTEL FROM HOTEL H INNER JOIN EMPRESAPROP P ON (H.IDPESSOA=P.IDPESSOA) AND COALESCE(P.FLGATIVO,'N')='S'))) D INNER JOIN
       TIPOUH T ON ((D.IDHOTEL = T.IDHOTEL) AND (T.FLGAPARECENADISP <> 'N') AND (COALESCE(T.FLGATIVA,'N') = 'S')) LEFT OUTER JOIN
       RESERVASFRONT R ON (T.IDHOTEL = R.IDHOTEL AND T.IDTIPOUH = R.TIPOUHESTADIA AND R.STATUSRESERVA < 4) LEFT OUTER JOIN
       ALLOTMENTXTIPOUH A ON (R.IDALLOTXTIPOUH = A.IDALLOTXTIPOUH AND R.IDHOTEL = A.IDHOTEL) INNER JOIN
       RESERVAREDUZ RD ON ((D.IDHOTEL = RD.IDHOTEL) AND (R.IDRESERVASFRONT = RD.IDRESERVASFRONT))
 WHERE
       (R.POOLLISTA = 'N')
   AND (R.IDROOMLIST IS NULL)
   AND (RD.DATACHEGADA <= D.DATA)
   AND (RD.DATAPARTIDA > D.DATA)
 GROUP BY D.DATA, R.IDHOTEL, T.CODREDUZIDO, T.IDTIPOUH
 ORDER BY R.IDHOTEL, D.DATA, T.IDTIPOUH, T.CODREDUZIDO


 ---Listar créditos

 SELECT L.IDLANCPONTOSTS, Decode(Sum(COALESCE(FP.IDRESERVASFRONT,0)), 0, 'N', 'S') AS FORADOPRAZO,
       -(SUM(DECODE(L.IDTIPOLANCAMENTO, 6, L.VLRLANCAMENTO, 0)) + SUM(DECODE(L.IDTIPOLANCAMENTO, 13, L.VLRLANCAMENTO, 0))) AS SALDO,
       -(SUM(DECODE(L.IDTIPOLANCAMENTO, 6, L.VLRLANCAMENTO, 0)) + SUM(DECODE(L.IDTIPOLANCAMENTO, 13, L.VLRLANCAMENTO, 0))) AS SALDODISP,
       MAX(L.VALIDADECREDITO) AS VALIDADECREDITO, R.NUMRESERVA, R.IDRESERVASFRONT
FROM   LANCAMENTOTS L, LANCPONTOSTS LP, RESERVASFRONT R,
       (SELECT IDRESERVASFRONT
        FROM   LANCPONTOSTS
        WHERE  IDVENDAXCONTRATO  = 5251
        AND    IDTIPOLANCPONTOTS = 5
        GROUP BY IDRESERVASFRONT) FP
WHERE  LP.IDVENDAXCONTRATO    = 5251
AND    LP.IDTIPOLANCPONTOTS   IN (1,4,5)
AND    R.IDRESERVASFRONT      = LP.IDRESERVASFRONT
AND    R.STATUSRESERVA        = 6
AND    L.IDLANCPONTOSTS       = LP.IDLANCPONTOSTS
AND    L.IDTIPOLANCAMENTO     IN (6, 13)
AND    LP.IDRESERVASFRONT     = FP.IDRESERVASFRONT (+)
AND    L.VALIDADECREDITO     >= TO_DATE('21/08/2025 00:00:00','DD/MM/YYYY HH24:MI:SS')
AND    L.IDLANCESTORNO       IS NULL
AND    L.IDMOTIVOESTORNO     IS NULL
 
GROUP BY L.IDLANCPONTOSTS, FP.IDRESERVASFRONT, R.NUMRESERVA, R.IDRESERVASFRONT
HAVING -(SUM(DECODE(L.IDTIPOLANCAMENTO, 6, L.VLRLANCAMENTO, 0)) + SUM(DECODE(L.IDTIPOLANCAMENTO, 13, L.VLRLANCAMENTO, 0))) > 0



SELECT COALESCE(R.DATAREVERSAO,V.DATAVENDA) AS DATAVENDA,
        
       TO_DATE('26/02/2026 00:00:00','DD/MM/YYYY HH24:MI:SS') -1 AS VALIDADECREDITO,

       RFV.PONTOSRF, RMV.PONTOSRM, PONTOSV.PONTOSOUTROS,
       (COALESCE(RFV.PONTOSRF,0) + COALESCE(RMV.PONTOSRM,0) + COALESCE(PONTOSV.PONTOSOUTROS,0)) AS PONTOSUTILIZADOS,
               
       CASE WHEN (RF.IDVENDAXCONTRATO IS NULL) AND (RM.IDVENDAXCONTRATO IS NULL) AND (PONTOS.IDVENDAXCONTRATO IS NULL) THEN
         CASE WHEN (C.NUMEROPONTOS - COALESCE(U.UTILIZACAO,0)) > (C.DESCONTOANUAL - (COALESCE(RFV.PONTOSRF,0) + COALESCE(RMV.PONTOSRM,0) + COALESCE(PONTOSV.PONTOSOUTROS,0))) THEN
           C.DESCONTOANUAL - (COALESCE(RFV.PONTOSRF,0) + COALESCE(RMV.PONTOSRM,0) + COALESCE(PONTOSV.PONTOSOUTROS,0))
         ELSE
           (C.NUMEROPONTOS - COALESCE(U.UTILIZACAO,0))
         END
       ELSE
         CASE WHEN (C.UTILIZACAOMINIMAPONTOS > 0) AND ((C.NUMEROPONTOS - COALESCE(U.UTILIZACAO,0)) > (C.UTILIZACAOMINIMAPONTOS - (COALESCE(RF.PONTOSRF,0) + COALESCE(RM.PONTOSRM,0) + COALESCE(PONTOS.PONTOSOUTROS,0) + COALESCE(RFV.PONTOSRF,0) + COALESCE(RMV.PONTOSRM,0) + COALESCE(PONTOSV.PONTOSOUTROS,0)))) THEN
           C.UTILIZACAOMINIMAPONTOS - (COALESCE(RF.PONTOSRF,0) + COALESCE(RM.PONTOSRM,0) + COALESCE(PONTOS.PONTOSOUTROS,0) + COALESCE(RFV.PONTOSRF,0) + COALESCE(RMV.PONTOSRM,0) + COALESCE(PONTOSV.PONTOSOUTROS,0) )
         ELSE
           (C.NUMEROPONTOS - COALESCE(U.UTILIZACAO,0))
         END
       END AS CREDITOPONTOS,
              
       C.DESCONTOANUAL, C.TAXAANUAL,
       C.IDCONTRATOTS, VC.NUMEROCONTRATO,
       P.NOME AS NOMECLIENTE, C.NOME AS NOMECONTRATO,
       VC.IDVENDAXCONTRATO, C.IDTIPODCTAXA, C.FLGGERACREDNUTIL, C.ANOINICIAL
FROM   VENDAXCONTRATOTS VC, VENDATS V, REVCONTRATOTS R, CONTRATOTS C,
       ATENDCLIENTETS A, PESSOA P, PARAMTS PAR,
      
       (SELECT LP.IDVENDAXCONTRATO, SUM(LP.NUMEROPONTOS) AS PONTOSRF
         FROM   LANCPONTOSTS LP, RESERVASFRONT RF, 
                (SELECT IDRESERVASFRONT FROM RESERVASRCI GROUP BY IDRESERVASFRONT) RCI, 
                PARAMTS PAR, VENDAXCONTRATOTS VC, VENDATS V, REVCONTRATOTS R
         WHERE  LP.IDRESERVASFRONT = RF.IDRESERVASFRONT
           AND    RCI.IDRESERVASFRONT (+) = RF.IDRESERVASFRONT           
           AND    LP.IDVENDAXCONTRATO     = VC.IDVENDAXCONTRATO
           AND    VC.IDVENDATS            = V.IDVENDATS           
           AND    VC.IDVENDAXCONTRATO     = R.IDVENDAXCONTRNOVO (+)
           AND    LP.NUMEROPONTOS > 0   
           AND    (                        
                 (RCI.IDRESERVASFRONT IS NULL 
            AND   (RF.STATUSRESERVA IN (0,1,2,3,4,5) OR (RF.STATUSRESERVA = 6 AND LP.IDTIPOLANCPONTOTS IN (4,5)))
            AND   TO_DATE('26/02/2024 00:00:00','DD/MM/YYYY HH24:MI:SS') <= RF.DATACHEGPREVISTA
            AND   TO_DATE('26/02/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') >  RF.DATACHEGPREVISTA
            AND   ((TO_DATE('26/02/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') <= LP.VALIDADECREDITO AND TO_DATE('26/02/2026 00:00:00','DD/MM/YYYY HH24:MI:SS') >=  LP.VALIDADECREDITO) OR LP.VALIDADECREDITO IS NULL)  )
               OR
                 (RCI.IDRESERVASFRONT IS NOT NULL
            AND   (RF.STATUSRESERVA IN (0,1,2,3,4,5) OR (RF.STATUSRESERVA = 6 AND LP.IDTIPOLANCPONTOTS IN (4,5)))
            AND   TO_DATE('26/02/2024 00:00:00','DD/MM/YYYY HH24:MI:SS') <= LP.DATALANCAMENTO
            AND   TO_DATE('26/02/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') >  LP.DATALANCAMENTO
            AND   ((TO_DATE('26/02/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') <= LP.VALIDADECREDITO AND TO_DATE('26/02/2026 00:00:00','DD/MM/YYYY HH24:MI:SS') >=  LP.VALIDADECREDITO) OR LP.VALIDADECREDITO IS NULL)  ))
         GROUP BY LP.IDVENDAXCONTRATO) RF,

       (SELECT LP.IDVENDAXCONTRATO, SUM(LP.NUMEROPONTOS) AS PONTOSRM
         FROM   LANCPONTOSTS LP, RESERVAMIGRADATS RM, 
                (SELECT IDRESERVAMIGRADA FROM RESERVASRCI GROUP BY IDRESERVAMIGRADA) RCI, 
                PARAMTS PAR, VENDAXCONTRATOTS VC, VENDATS V, REVCONTRATOTS R
         WHERE  LP.IDRESERVAMIGRADA = RM.IDRESERVAMIGRADA
           AND    RCI.IDRESERVAMIGRADA (+) = RM.IDRESERVAMIGRADA
           AND    LP.IDVENDAXCONTRATO      = VC.IDVENDAXCONTRATO
           AND    VC.IDVENDATS             = V.IDVENDATS
           AND    VC.IDVENDAXCONTRATO      = R.IDVENDAXCONTRNOVO (+)
           AND    LP.NUMEROPONTOS > 0
           AND    (
                 (RCI.IDRESERVAMIGRADA IS NULL
           AND   TO_DATE('26/02/2024 00:00:00','DD/MM/YYYY HH24:MI:SS') <= RM.DATACHEGADA
           AND   TO_DATE('26/02/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') >  RM.DATACHEGADA
           AND    LP.VALIDADECREDITO IS NULL)
              OR
                 (RCI.IDRESERVAMIGRADA IS NOT NULL
           AND   TO_DATE('26/02/2024 00:00:00','DD/MM/YYYY HH24:MI:SS') <= LP.DATALANCAMENTO
           AND   TO_DATE('26/02/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') >  LP.DATALANCAMENTO
           AND    LP.VALIDADECREDITO IS NULL))
         GROUP BY LP.IDVENDAXCONTRATO) RM,

       (SELECT LP.IDVENDAXCONTRATO, SUM(LP.NUMEROPONTOS)  AS PONTOSOUTROS
         FROM   LANCPONTOSTS LP, MOTIVOTS M, PARAMTS PAR, VENDAXCONTRATOTS VC, VENDATS V, REVCONTRATOTS R
         WHERE  LP.IDRESERVAMIGRADA IS NULL
           AND  LP.IDVENDAXCONTRATO = VC.IDVENDAXCONTRATO
           AND  VC.IDVENDATS        = V.IDVENDATS
           AND  VC.IDVENDAXCONTRATO = R.IDVENDAXCONTRNOVO (+)
           AND  LP.IDRESERVASFRONT IS NULL
           AND  LP.NUMEROPONTOS > 0
           AND ((LP.IDTIPOLANCPONTOTS IN (2,4)
                AND   TO_DATE('26/02/2024 00:00:00','DD/MM/YYYY HH24:MI:SS') <  LP.DATALANCAMENTO
                AND   TO_DATE('26/02/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') >= LP.DATALANCAMENTO)
              OR
                (LP.IDTIPOLANCPONTOTS NOT IN (2,4)
                AND   TO_DATE('26/02/2024 00:00:00','DD/MM/YYYY HH24:MI:SS') <= LP.DATALANCAMENTO
                AND   TO_DATE('26/02/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') >  LP.DATALANCAMENTO))
           AND  LP.IDMOTIVO = M.IDMOTIVOTS 
           AND  M.FLGCONTAUTILIZACAO = 'S'
           AND  LP.VALIDADECREDITO IS NULL
           AND  LP.DEBITOCREDITO = 'D'     
         GROUP BY LP.IDVENDAXCONTRATO    
      ) PONTOS,      
      
       (SELECT LP.IDVENDAXCONTRATO, SUM(LP.NUMEROPONTOS) AS PONTOSRF
         FROM   LANCPONTOSTS LP, RESERVASFRONT RF, 
                (SELECT IDRESERVASFRONT FROM RESERVASRCI GROUP BY IDRESERVASFRONT) RCI, 
                PARAMTS PAR, VENDAXCONTRATOTS VC, VENDATS V, REVCONTRATOTS R
         WHERE  LP.IDRESERVASFRONT = RF.IDRESERVASFRONT
           AND    RCI.IDRESERVASFRONT (+) = RF.IDRESERVASFRONT
           AND    LP.IDVENDAXCONTRATO = VC.IDVENDAXCONTRATO
           AND    VC.IDVENDATS = V.IDVENDATS
           AND    VC.IDVENDAXCONTRATO = R.IDVENDAXCONTRNOVO (+)
           AND    LP.NUMEROPONTOS > 0           AND    (                        
                 (RCI.IDRESERVASFRONT IS NULL 
            AND   (RF.STATUSRESERVA IN (0,1,2,3,4,5) OR (RF.STATUSRESERVA = 6 AND LP.IDTIPOLANCPONTOTS IN (4,5)))
            AND   TO_DATE('26/02/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') <= RF.DATACHEGPREVISTA
            AND   TO_DATE('26/02/2026 00:00:00','DD/MM/YYYY HH24:MI:SS') >  RF.DATACHEGPREVISTA
            )
               OR
                 (RCI.IDRESERVASFRONT IS NOT NULL
            AND   (RF.STATUSRESERVA IN (0,1,2,3,4,5) OR (RF.STATUSRESERVA = 6 AND LP.IDTIPOLANCPONTOTS IN (4,5)))
            AND   TO_DATE('26/02/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') <= LP.DATALANCAMENTO
            AND   TO_DATE('26/02/2026 00:00:00','DD/MM/YYYY HH24:MI:SS') >  LP.DATALANCAMENTO
            ))
         GROUP BY LP.IDVENDAXCONTRATO) RFV, 
       
       (SELECT LP.IDVENDAXCONTRATO, SUM(LP.NUMEROPONTOS) AS PONTOSRM
         FROM   LANCPONTOSTS LP, RESERVAMIGRADATS RM, 
                (SELECT IDRESERVAMIGRADA FROM RESERVASRCI GROUP BY IDRESERVAMIGRADA) RCI, 
                PARAMTS PAR, VENDAXCONTRATOTS VC, VENDATS V, REVCONTRATOTS R
         WHERE  LP.IDRESERVAMIGRADA = RM.IDRESERVAMIGRADA
           AND    RCI.IDRESERVAMIGRADA (+) = RM.IDRESERVAMIGRADA
           AND    LP.IDVENDAXCONTRATO      = VC.IDVENDAXCONTRATO
           AND    VC.IDVENDATS             = V.IDVENDATS
           AND    VC.IDVENDAXCONTRATO      = R.IDVENDAXCONTRNOVO (+)
           AND    LP.NUMEROPONTOS > 0  
           AND    ((RCI.IDRESERVAMIGRADA IS NULL 
                 AND TO_DATE('26/02/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') <= RM.DATACHEGADA
                 AND TO_DATE('26/02/2026 00:00:00','DD/MM/YYYY HH24:MI:SS') >  RM.DATACHEGADA)
              OR
                 (RCI.IDRESERVAMIGRADA IS NOT NULL
                 AND TO_DATE('26/02/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') <= LP.DATALANCAMENTO
                 AND TO_DATE('26/02/2026 00:00:00','DD/MM/YYYY HH24:MI:SS') >  LP.DATALANCAMENTO))
         GROUP BY LP.IDVENDAXCONTRATO) RMV,
      
       (SELECT LP.IDVENDAXCONTRATO, SUM(LP.NUMEROPONTOS)  AS PONTOSOUTROS
         FROM   LANCPONTOSTS LP, MOTIVOTS M, PARAMTS PAR, VENDAXCONTRATOTS VC, VENDATS V, REVCONTRATOTS R
         WHERE  LP.IDRESERVAMIGRADA IS NULL
           AND  LP.IDVENDAXCONTRATO = VC.IDVENDAXCONTRATO
           AND  VC.IDVENDATS        = V.IDVENDATS
           AND  VC.IDVENDAXCONTRATO = R.IDVENDAXCONTRNOVO (+)
           AND  LP.NUMEROPONTOS > 0           
           AND  ((LP.IDTIPOLANCPONTOTS IN (2,4) 
                 AND TO_DATE('26/02/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') <  LP.DATALANCAMENTO
                 AND TO_DATE('26/02/2026 00:00:00','DD/MM/YYYY HH24:MI:SS') >= LP.DATALANCAMENTO)
               OR
                (LP.IDTIPOLANCPONTOTS NOT IN (2,4)
                 AND TO_DATE('26/02/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') <= LP.DATALANCAMENTO
                 AND TO_DATE('26/02/2026 00:00:00','DD/MM/YYYY HH24:MI:SS') >  LP.DATALANCAMENTO))           
           AND  LP.IDMOTIVO = M.IDMOTIVOTS
           AND  M.FLGCONTAUTILIZACAO = 'S'
           AND  LP.DEBITOCREDITO = 'D'    
         GROUP BY LP.IDVENDAXCONTRATO) PONTOSV,
         
       (SELECT LP.IDVENDAXCONTRATO, SUM(LP.NUMEROPONTOS)  AS PONTOS
         FROM   LANCPONTOSTS LP, PARAMTS PAR, VENDAXCONTRATOTS VC, VENDATS V, REVCONTRATOTS R
         WHERE  LP.IDVENDAXCONTRATO = VC.IDVENDAXCONTRATO
           AND  VC.IDVENDATS        = V.IDVENDATS
           AND  VC.IDVENDAXCONTRATO = R.IDVENDAXCONTRNOVO (+)
           AND  LP.NUMEROPONTOS > 0
           AND  LP.DEBITOCREDITO = 'D'
           AND  LP.VALIDADECREDITO IS NOT NULL
           AND  TO_DATE('26/02/2024 00:00:00','DD/MM/YYYY HH24:MI:SS') = LP.VALIDADECREDITO
         GROUP BY LP.IDVENDAXCONTRATO) PONTOSVEXTRA,          
      
       (SELECT LP.IDVENDAXCONTRATO, COALESCE(SUM(DECODE(LP.DEBITOCREDITO,'D',LP.NUMEROPONTOS,-LP.NUMEROPONTOS)),0) AS UTILIZACAO
         FROM LANCPONTOSTS LP
         WHERE NOT EXISTS(SELECT R.IDRESERVASFRONT FROM RESERVASFRONT R WHERE R.IDRESERVASFRONT = LP.IDRESERVASFRONT AND R.STATUSRESERVA = 6)
         GROUP BY IDVENDAXCONTRATO) U
     
WHERE  VC.FLGREVERTIDO          = 'N'
AND    (VC.IDVENDAXCONTRATO     = 5127)
AND    VC.FLGCANCELADO          = 'N'
AND    VC.IDVENDAXCONTRATO      = RF.IDVENDAXCONTRATO (+)
AND    VC.IDVENDAXCONTRATO      = RM.IDVENDAXCONTRATO (+)
AND    VC.IDVENDAXCONTRATO      = PONTOS.IDVENDAXCONTRATO (+)
AND    VC.IDVENDAXCONTRATO      = RFV.IDVENDAXCONTRATO (+)
AND    VC.IDVENDAXCONTRATO      = RMV.IDVENDAXCONTRATO (+)
AND    VC.IDVENDAXCONTRATO      = PONTOSV.IDVENDAXCONTRATO (+)
AND    VC.IDVENDAXCONTRATO      = PONTOSVEXTRA.IDVENDAXCONTRATO (+)
AND    VC.IDVENDAXCONTRATO      = R.IDVENDAXCONTRNOVO (+)
AND    VC.IDVENDAXCONTRATO      = U.IDVENDAXCONTRATO (+)
AND    V.IDVENDATS              = VC.IDVENDATS
AND    C.IDCONTRATOTS           = VC.IDCONTRATOTS
AND    A.IDATENDCLIENTETS       = V.IDATENDCLIENTETS
AND    P.IDPESSOA               = A.IDCLIENTE
AND    (COALESCE(C.DESCONTOANUAL, 0) > 0 OR COALESCE(C.TAXAANUAL, 0) > 0)

AND   ( (  (RF.IDVENDAXCONTRATO IS NULL) AND (RM.IDVENDAXCONTRATO IS NULL) AND (PONTOS.IDVENDAXCONTRATO IS NULL) )
   OR ( ( COALESCE(RF.PONTOSRF,0) + COALESCE(RM.PONTOSRM,0) + COALESCE(PONTOS.PONTOSOUTROS,0) + COALESCE(RFV.PONTOSRF,0) + COALESCE(RMV.PONTOSRM,0) + COALESCE(PONTOSV.PONTOSOUTROS,0)  ) <= C.UTILIZACAOMINIMAPONTOS ) )

AND    COALESCE(U.UTILIZACAO,0) < C.NUMEROPONTOS
AND    COALESCE(PONTOSVEXTRA.PONTOS,0) < C.DESCONTOANUAL
AND    (COALESCE(RFV.PONTOSRF,0) + COALESCE(RMV.PONTOSRM,0) + COALESCE(PONTOSV.PONTOSOUTROS,0)) < C.DESCONTOANUAL
AND    ADD_MONTHS(COALESCE(R.DATAREVERSAO,V.DATAVENDA), 12) <= PAR.DATASISTEMA
 AND C.FLGGERACREDNUTIL = 'S'
AND    (TO_DATE('26/02/2026 00:00:00','DD/MM/YYYY HH24:MI:SS') -1) >= TO_DATE('02/11/2025 00:00:00','DD/MM/YYYY HH24:MI:SS')
AND    TO_DATE('02/11/2025 00:00:00','DD/MM/YYYY HH24:MI:SS') >= TO_DATE('26/02/2025 00:00:00','DD/MM/YYYY HH24:MI:SS')




SELECT COALESCE(R.DATAREVERSAO,V.DATAVENDA) AS DATAVENDA,
        
                                       :dataDebitoPrevisto as VALIDADECREDITO,      

                                       RFV.PONTOSRF, RMV.PONTOSRM, PONTOSV.PONTOSOUTROS,
                                       (COALESCE(RFV.PONTOSRF,0) + COALESCE(RMV.PONTOSRM,0) + COALESCE(PONTOSV.PONTOSOUTROS,0)) AS PONTOSUTILIZADOS,
               
                                       CASE WHEN (RF.IDVENDAXCONTRATO IS NULL) AND (RM.IDVENDAXCONTRATO IS NULL) AND (PONTOS.IDVENDAXCONTRATO IS NULL) THEN
                                         CASE WHEN (C.NUMEROPONTOS - COALESCE(U.UTILIZACAO,0)) > (C.DESCONTOANUAL - (COALESCE(RFV.PONTOSRF,0) + COALESCE(RMV.PONTOSRM,0) + COALESCE(PONTOSV.PONTOSOUTROS,0))) THEN
                                           C.DESCONTOANUAL - (COALESCE(RFV.PONTOSRF,0) + COALESCE(RMV.PONTOSRM,0) + COALESCE(PONTOSV.PONTOSOUTROS,0))
                                         ELSE
                                           (C.NUMEROPONTOS - COALESCE(U.UTILIZACAO,0))
                                         END
                                       ELSE
                                         CASE WHEN (C.UTILIZACAOMINIMAPONTOS > 0) AND ((C.NUMEROPONTOS - COALESCE(U.UTILIZACAO,0)) > (C.UTILIZACAOMINIMAPONTOS - (COALESCE(RF.PONTOSRF,0) + COALESCE(RM.PONTOSRM,0) + COALESCE(PONTOS.PONTOSOUTROS,0) + COALESCE(RFV.PONTOSRF,0) + COALESCE(RMV.PONTOSRM,0) + COALESCE(PONTOSV.PONTOSOUTROS,0)))) THEN
                                           C.UTILIZACAOMINIMAPONTOS - (COALESCE(RF.PONTOSRF,0) + COALESCE(RM.PONTOSRM,0) + COALESCE(PONTOS.PONTOSOUTROS,0) + COALESCE(RFV.PONTOSRF,0) + COALESCE(RMV.PONTOSRM,0) + COALESCE(PONTOSV.PONTOSOUTROS,0) )
                                         ELSE
                                           (C.NUMEROPONTOS - COALESCE(U.UTILIZACAO,0))
                                         END
                                       END AS CREDITOPONTOS,
              
                                       C.DESCONTOANUAL, C.TAXAANUAL,
                                       C.IDCONTRATOTS, VC.NUMEROCONTRATO,
                                       P.NOME AS NOMECLIENTE, C.NOME AS NOMECONTRATO,
                                       VC.IDVENDAXCONTRATO, C.IDTIPODCTAXA, C.FLGGERACREDNUTIL, C.ANOINICIAL
                                FROM   VENDAXCONTRATOTS VC, VENDATS V, REVCONTRATOTS R, CONTRATOTS C,
                                       ATENDCLIENTETS A, PESSOA P, PARAMTS PAR,
      
                                       (SELECT LP.IDVENDAXCONTRATO, SUM(LP.NUMEROPONTOS) AS PONTOSRF
                                         FROM   LANCPONTOSTS LP, RESERVASFRONT RF, 
                                                (SELECT IDRESERVASFRONT FROM RESERVASRCI GROUP BY IDRESERVASFRONT) RCI, 
                                                PARAMTS PAR, VENDAXCONTRATOTS VC, VENDATS V, REVCONTRATOTS R
                                         WHERE  LP.IDRESERVASFRONT = RF.IDRESERVASFRONT
                                           AND    RCI.IDRESERVASFRONT (+) = RF.IDRESERVASFRONT           
                                           AND    LP.IDVENDAXCONTRATO     = VC.IDVENDAXCONTRATO
                                           AND    VC.IDVENDATS            = V.IDVENDATS           
                                           AND    VC.IDVENDAXCONTRATO     = R.IDVENDAXCONTRNOVO (+)
                                           AND    LP.NUMEROPONTOS > 0   
                                           AND    (                        
                                                 (RCI.IDRESERVASFRONT IS NULL 
                                            AND   (RF.STATUSRESERVA IN (0,1,2,3,4,5) OR (RF.STATUSRESERVA = 6 AND LP.IDTIPOLANCPONTOTS IN (4,5)))
                                            AND   :dataBaseInicialAnoAnterior <= RF.DATACHEGPREVISTA
                                            AND   :dataInicioApuracaoDebito >  RF.DATACHEGPREVISTA
                                            AND   ((:dataInicioApuracaoDebito <= LP.VALIDADECREDITO AND :dataProximoDebitoPontos >=  LP.VALIDADECREDITO) OR LP.VALIDADECREDITO IS NULL)  )
                                               OR
                                                 (RCI.IDRESERVASFRONT IS NOT NULL
                                            AND   (RF.STATUSRESERVA IN (0,1,2,3,4,5) OR (RF.STATUSRESERVA = 6 AND LP.IDTIPOLANCPONTOTS IN (4,5)))
                                            AND   :dataBaseInicialAnoAnterior <= LP.DATALANCAMENTO
                                            AND   :dataInicioApuracaoDebito >  LP.DATALANCAMENTO
                                            AND   ((:dataInicioApuracaoDebito <= LP.VALIDADECREDITO AND :dataProximoDebitoPontos >=  LP.VALIDADECREDITO) OR LP.VALIDADECREDITO IS NULL)  ))
                                         GROUP BY LP.IDVENDAXCONTRATO) RF,

                                       (SELECT LP.IDVENDAXCONTRATO, SUM(LP.NUMEROPONTOS) AS PONTOSRM
                                         FROM   LANCPONTOSTS LP, RESERVAMIGRADATS RM, 
                                                (SELECT IDRESERVAMIGRADA FROM RESERVASRCI GROUP BY IDRESERVAMIGRADA) RCI, 
                                                PARAMTS PAR, VENDAXCONTRATOTS VC, VENDATS V, REVCONTRATOTS R
                                         WHERE  LP.IDRESERVAMIGRADA = RM.IDRESERVAMIGRADA
                                           AND    RCI.IDRESERVAMIGRADA (+) = RM.IDRESERVAMIGRADA
                                           AND    LP.IDVENDAXCONTRATO      = VC.IDVENDAXCONTRATO
                                           AND    VC.IDVENDATS             = V.IDVENDATS
                                           AND    VC.IDVENDAXCONTRATO      = R.IDVENDAXCONTRNOVO (+)
                                           AND    LP.NUMEROPONTOS > 0
                                           AND    (
                                                 (RCI.IDRESERVAMIGRADA IS NULL
                                           AND   :dataBaseInicialAnoAnterior <= RM.DATACHEGADA
                                           AND   :dataInicioApuracaoDebito >  RM.DATACHEGADA
                                           AND    LP.VALIDADECREDITO IS NULL)
                                              OR
                                                 (RCI.IDRESERVAMIGRADA IS NOT NULL
                                           AND   :dataBaseInicialAnoAnterior <= LP.DATALANCAMENTO
                                           AND   :dataInicioApuracaoDebito >  LP.DATALANCAMENTO
                                           AND    LP.VALIDADECREDITO IS NULL))
                                         GROUP BY LP.IDVENDAXCONTRATO) RM,

                                       (SELECT LP.IDVENDAXCONTRATO, SUM(LP.NUMEROPONTOS)  AS PONTOSOUTROS
                                         FROM   LANCPONTOSTS LP, MOTIVOTS M, PARAMTS PAR, VENDAXCONTRATOTS VC, VENDATS V, REVCONTRATOTS R
                                         WHERE  LP.IDRESERVAMIGRADA IS NULL
                                           AND  LP.IDVENDAXCONTRATO = VC.IDVENDAXCONTRATO
                                           AND  VC.IDVENDATS        = V.IDVENDATS
                                           AND  VC.IDVENDAXCONTRATO = R.IDVENDAXCONTRNOVO (+)
                                           AND  LP.IDRESERVASFRONT IS NULL
                                           AND  LP.NUMEROPONTOS > 0
                                           AND ((LP.IDTIPOLANCPONTOTS IN (2,4)
                                                AND   :dataBaseInicialAnoAnterior <  LP.DATALANCAMENTO
                                                AND   :dataInicioApuracaoDebito >= LP.DATALANCAMENTO)
                                              OR
                                                (LP.IDTIPOLANCPONTOTS NOT IN (2,4)
                                                AND   :dataBaseInicialAnoAnterior <= LP.DATALANCAMENTO
                                                AND   :dataInicioApuracaoDebito >  LP.DATALANCAMENTO))
                                           AND  LP.IDMOTIVO = M.IDMOTIVOTS 
                                           AND  M.FLGCONTAUTILIZACAO = 'S'
                                           AND  LP.VALIDADECREDITO IS NULL
                                           AND  LP.DEBITOCREDITO = 'D'     
                                         GROUP BY LP.IDVENDAXCONTRATO    
                                      ) PONTOS,      
      
                                       (SELECT LP.IDVENDAXCONTRATO, SUM(LP.NUMEROPONTOS) AS PONTOSRF
                                         FROM   LANCPONTOSTS LP, RESERVASFRONT RF, 
                                                (SELECT IDRESERVASFRONT FROM RESERVASRCI GROUP BY IDRESERVASFRONT) RCI, 
                                                PARAMTS PAR, VENDAXCONTRATOTS VC, VENDATS V, REVCONTRATOTS R
                                         WHERE  LP.IDRESERVASFRONT = RF.IDRESERVASFRONT
                                           AND    RCI.IDRESERVASFRONT (+) = RF.IDRESERVASFRONT
                                           AND    LP.IDVENDAXCONTRATO = VC.IDVENDAXCONTRATO
                                           AND    VC.IDVENDATS = V.IDVENDATS
                                           AND    VC.IDVENDAXCONTRATO = R.IDVENDAXCONTRNOVO (+)
                                           AND    LP.NUMEROPONTOS > 0           AND    (                        
                                                 (RCI.IDRESERVASFRONT IS NULL 
                                            AND   (RF.STATUSRESERVA IN (0,1,2,3,4,5) OR (RF.STATUSRESERVA = 6 AND LP.IDTIPOLANCPONTOTS IN (4,5)))
                                            AND   :dataInicioApuracaoDebito <= RF.DATACHEGPREVISTA
                                            AND   :dataProximoDebitoPontos >  RF.DATACHEGPREVISTA
                                            )
                                               OR
                                                 (RCI.IDRESERVASFRONT IS NOT NULL
                                            AND   (RF.STATUSRESERVA IN (0,1,2,3,4,5) OR (RF.STATUSRESERVA = 6 AND LP.IDTIPOLANCPONTOTS IN (4,5)))
                                            AND   :dataInicioApuracaoDebito <= LP.DATALANCAMENTO
                                            AND   :dataProximoDebitoPontos >  LP.DATALANCAMENTO
                                            ))
                                         GROUP BY LP.IDVENDAXCONTRATO) RFV, 
       
                                       (SELECT LP.IDVENDAXCONTRATO, SUM(LP.NUMEROPONTOS) AS PONTOSRM
                                         FROM   LANCPONTOSTS LP, RESERVAMIGRADATS RM, 
                                                (SELECT IDRESERVAMIGRADA FROM RESERVASRCI GROUP BY IDRESERVAMIGRADA) RCI, 
                                                PARAMTS PAR, VENDAXCONTRATOTS VC, VENDATS V, REVCONTRATOTS R
                                         WHERE  LP.IDRESERVAMIGRADA = RM.IDRESERVAMIGRADA
                                           AND    RCI.IDRESERVAMIGRADA (+) = RM.IDRESERVAMIGRADA
                                           AND    LP.IDVENDAXCONTRATO      = VC.IDVENDAXCONTRATO
                                           AND    VC.IDVENDATS             = V.IDVENDATS
                                           AND    VC.IDVENDAXCONTRATO      = R.IDVENDAXCONTRNOVO (+)
                                           AND    LP.NUMEROPONTOS > 0  
                                           AND    ((RCI.IDRESERVAMIGRADA IS NULL 
                                                 AND :dataInicioApuracaoDebito <= RM.DATACHEGADA
                                                 AND :dataProximoDebitoPontos >  RM.DATACHEGADA)
                                              OR
                                                 (RCI.IDRESERVAMIGRADA IS NOT NULL
                                                 AND :dataInicioApuracaoDebito <= LP.DATALANCAMENTO
                                                 AND :dataProximoDebitoPontos >  LP.DATALANCAMENTO))
                                         GROUP BY LP.IDVENDAXCONTRATO) RMV,
      
                                       (SELECT LP.IDVENDAXCONTRATO, SUM(LP.NUMEROPONTOS)  AS PONTOSOUTROS
                                         FROM   LANCPONTOSTS LP, MOTIVOTS M, PARAMTS PAR, VENDAXCONTRATOTS VC, VENDATS V, REVCONTRATOTS R
                                         WHERE  LP.IDRESERVAMIGRADA IS NULL
                                           AND  LP.IDVENDAXCONTRATO = VC.IDVENDAXCONTRATO
                                           AND  VC.IDVENDATS        = V.IDVENDATS
                                           AND  VC.IDVENDAXCONTRATO = R.IDVENDAXCONTRNOVO (+)
                                           AND  LP.NUMEROPONTOS > 0           
                                           AND  ((LP.IDTIPOLANCPONTOTS IN (2,4) 
                                                 AND :dataInicioApuracaoDebito <  LP.DATALANCAMENTO
                                                 AND :dataProximoDebitoPontos >= LP.DATALANCAMENTO)
                                               OR
                                                (LP.IDTIPOLANCPONTOTS NOT IN (2,4)
                                                 AND :dataInicioApuracaoDebito <= LP.DATALANCAMENTO
                                                 AND :dataProximoDebitoPontos >  LP.DATALANCAMENTO))           
                                           AND  LP.IDMOTIVO = M.IDMOTIVOTS
                                           AND  M.FLGCONTAUTILIZACAO = 'S'
                                           AND  LP.DEBITOCREDITO = 'D'    
                                         GROUP BY LP.IDVENDAXCONTRATO) PONTOSV,
         
                                       (SELECT LP.IDVENDAXCONTRATO, SUM(LP.NUMEROPONTOS)  AS PONTOS
                                         FROM   LANCPONTOSTS LP, PARAMTS PAR, VENDAXCONTRATOTS VC, VENDATS V, REVCONTRATOTS R
                                         WHERE  LP.IDVENDAXCONTRATO = VC.IDVENDAXCONTRATO
                                           AND  VC.IDVENDATS        = V.IDVENDATS
                                           AND  VC.IDVENDAXCONTRATO = R.IDVENDAXCONTRNOVO (+)
                                           AND  LP.NUMEROPONTOS > 0
                                           AND  LP.DEBITOCREDITO = 'D'
                                           AND  LP.VALIDADECREDITO IS NOT NULL
                                           AND  :dataBaseInicialAnoAnterior = LP.VALIDADECREDITO
                                         GROUP BY LP.IDVENDAXCONTRATO) PONTOSVEXTRA,          
      
                                       (SELECT LP.IDVENDAXCONTRATO, COALESCE(SUM(DECODE(LP.DEBITOCREDITO,'D',LP.NUMEROPONTOS,-LP.NUMEROPONTOS)),0) AS UTILIZACAO
                                         FROM LANCPONTOSTS LP
                                         WHERE NOT EXISTS(SELECT R.IDRESERVASFRONT FROM RESERVASFRONT R WHERE R.IDRESERVASFRONT = LP.IDRESERVASFRONT AND R.STATUSRESERVA = 6)
                                         GROUP BY IDVENDAXCONTRATO) U
     
                                WHERE  VC.FLGREVERTIDO          = 'N'
                                AND    (VC.IDVENDAXCONTRATO     = :idVendaXContrato)
                                AND    VC.FLGCANCELADO          = 'N'
                                AND    VC.IDVENDAXCONTRATO      = RF.IDVENDAXCONTRATO (+)
                                AND    VC.IDVENDAXCONTRATO      = RM.IDVENDAXCONTRATO (+)
                                AND    VC.IDVENDAXCONTRATO      = PONTOS.IDVENDAXCONTRATO (+)
                                AND    VC.IDVENDAXCONTRATO      = RFV.IDVENDAXCONTRATO (+)
                                AND    VC.IDVENDAXCONTRATO      = RMV.IDVENDAXCONTRATO (+)
                                AND    VC.IDVENDAXCONTRATO      = PONTOSV.IDVENDAXCONTRATO (+)
                                AND    VC.IDVENDAXCONTRATO      = PONTOSVEXTRA.IDVENDAXCONTRATO (+)
                                AND    VC.IDVENDAXCONTRATO      = R.IDVENDAXCONTRNOVO (+)
                                AND    VC.IDVENDAXCONTRATO      = U.IDVENDAXCONTRATO (+)
                                AND    V.IDVENDATS              = VC.IDVENDATS
                                AND    C.IDCONTRATOTS           = VC.IDCONTRATOTS
                                AND    A.IDATENDCLIENTETS       = V.IDATENDCLIENTETS
                                AND    P.IDPESSOA               = A.IDCLIENTE
                                AND    (COALESCE(C.DESCONTOANUAL, 0) > 0 OR COALESCE(C.TAXAANUAL, 0) > 0)

                                AND   ( (  (RF.IDVENDAXCONTRATO IS NULL) AND (RM.IDVENDAXCONTRATO IS NULL) AND (PONTOS.IDVENDAXCONTRATO IS NULL) )
                                   OR ( ( COALESCE(RF.PONTOSRF,0) + COALESCE(RM.PONTOSRM,0) + COALESCE(PONTOS.PONTOSOUTROS,0) + COALESCE(RFV.PONTOSRF,0) + COALESCE(RMV.PONTOSRM,0) + COALESCE(PONTOSV.PONTOSOUTROS,0)  ) <= C.UTILIZACAOMINIMAPONTOS ) )

                                AND    COALESCE(U.UTILIZACAO,0) < C.NUMEROPONTOS
                                AND    COALESCE(PONTOSVEXTRA.PONTOS,0) < C.DESCONTOANUAL
                                AND    (COALESCE(RFV.PONTOSRF,0) + COALESCE(RMV.PONTOSRM,0) + COALESCE(PONTOSV.PONTOSOUTROS,0)) < C.DESCONTOANUAL
                                AND    ADD_MONTHS(COALESCE(R.DATAREVERSAO,V.DATAVENDA), 12) <= PAR.DATASISTEMA
                                 AND C.FLGGERACREDNUTIL = 'S'
                                AND    :dataDebitoPrevisto >= :dataAtualMais6Meses
                                AND    :dataAtualMais6Meses >= :dataInicioApuracaoDebito